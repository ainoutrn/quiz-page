<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="stylesheet" href="style.css">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<title>AI脳トレ</title>
<script>

var testMode = false; //テスト時にローディングを高速化できる
const FINAL_STAGE = 5;

// --- 問題データ ---
const quizData=[
  {"stage":"0","mode":"","quiztype":"質問1","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"あなたの性別は？","image":"","music":"","image2":"","image2time":"","options":[{"text":"男性"},{"text":"女性"},{"text":""},{"text":""}],"correct":"","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"0","mode":"","quiztype":"質問2","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"あなたの年齢は？","image":"","music":"","image2":"","image2time":"","options":[{"text":"～20"},{"text":"21～40"},{"text":"41～60"},{"text":"61～"}],"correct":"","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"0","mode":"","quiztype":"質問3","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"以下でよろしいですか？<br><br>性別年代","image":"","music":"","image2":"","image2time":"","options":[{"text":"はい"},{"text":"いいえ"},{"text":""},{"text":""}],"correct":"はい","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"1","mode":"","quiztype":"計算力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"３５－３０＝？","image":"","music":"","image2":"","image2time":"","options":[{"text":"5"},{"text":"7"},{"text":""},{"text":""}],"correct":"5","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"1","mode":"","quiztype":"空間認識力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"バスの進行方向は？","image":"images/bus_left.png","music":"","image2":"","image2time":"","options":[{"text":"左"},{"text":"右"},{"text":""},{"text":""}],"correct":"左","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"1","mode":"","quiztype":"色彩認識力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"この中で一番大きいマルは？","image":"images/ookiimaru.png","music":"","image2":"","image2time":"","options":[{"text":"青"},{"text":"赤"},{"text":""},{"text":""}],"correct":"赤","answerPict":"","rand":true,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"1","mode":"renda","quiztype":"運動神経伝達力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"連打して！","image":"images/yubirenda.png","music":"","image2":"","image2time":"","options":[{"text":"連打!"},{"text":""},{"text":""},{"text":""}],"correct":"","answerPict":"","rand":false,"answertime":5000,"answerstart":5000,"perfect":50,"excellent":40,"great":30,"good":20,"safe":10,"banner":""},
  {"stage":"1","mode":"","quiztype":"注意力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"じゃんけんで勝って！","image":"images/goo.png","music":"","image2":"","image2time":"","options":[{"text":"images/tyoki.png"},{"text":"images/paa.png"},{"text":""},{"text":""}],"correct":"images/paa.png","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"1","mode":"","quiztype":"形状判断力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"若いのは？","image":"","music":"","image2":"","image2time":"","options":[{"text":"images/ageha.png"},{"text":"images/sanagi.png"},{"text":""},{"text":""}],"correct":"images/sanagi.png","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"1","mode":"","quiztype":"パターン認識力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"あてはまるのは？","image":"images/num1.png","music":"","image2":"","image2time":"","options":[{"text":"5"},{"text":"2"},{"text":""},{"text":""}],"correct":"2","answerPict":"","rand":true,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"1","mode":"mikiri","quiztype":"運動神経伝達力","beforeTxt":"もぐらが出たらたたけ！","beforeImg":"images/mogu1.png","beforeMusic":"","beforeTime":"8000","question":"もぐらが出たらたたけ！","image":"images/mogu2.png","music":"","image2":"","image2time":"","options":[{"text":"たたく"},{"text":""},{"text":""},{"text":""}],"correct":"たたく","answerPict":"","rand":false,"answertime":4000,"answerstart":4000,"perfect":3500,"excellent":3000,"great":2000,"good":1000,"safe":0,"banner":""},
  {"stage":"2","mode":"","quiztype":"注意力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"じゃんけんで負けて！","image":"images/tyoki.png","music":"","image2":"","image2time":"","options":[{"text":"images/goo.png"},{"text":"images/tyoki.png"},{"text":"images/paa.png"},{"text":""}],"correct":"images/paa.png","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"2","mode":"","quiztype":"注意力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"文字数が多いのは？","image":"images/moji1.png","music":"","image2":"","image2time":"","options":[{"text":"S"},{"text":"A"},{"text":""},{"text":""}],"correct":"S","answerPict":"","rand":true,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"2","mode":"kioku","quiztype":"記憶力","beforeTxt":"画像を覚えて！","beforeImg":"images/yatyo.png","beforeMusic":"","beforeTime":"4000","question":"野鳥の数は？","image":"","music":"","image2":"","image2time":"","options":[{"text":"1"},{"text":"2"},{"text":"3"},{"text":"4"}],"correct":"3","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"2","mode":"","quiztype":"形状判断力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"一番若いのは？","image":"","music":"","image2":"","image2time":"","options":[{"text":"images/egg.png"},{"text":"images/otama.png"},{"text":"images/otama2.png"},{"text":"images/kaeru.png"}],"correct":"images/egg.png","answerPict":"","rand":true,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"2","mode":"","quiztype":"音感","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"どの音階？","image":"images/kiite.png","music":"re","image2":"","image2time":"","options":[{"text":"ド"},{"text":"レ"},{"text":"ミ"},{"text":"ファ"}],"correct":"レ","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"2","mode":"","quiztype":"パターン認識力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"あてはまるのは？","image":"images/nums.png","music":"","image2":"","image2time":"","options":[{"text":"9"},{"text":"11"},{"text":"13"},{"text":"15"}],"correct":"13","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"2","mode":"","quiztype":"形状判断力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"あてはまるのは？","image":"images/tako.png","music":"","image2":"","image2time":"","options":[{"text":"images/tako_p1.png"},{"text":"images/tako_p2.png"},{"text":""},{"text":""}],"correct":"images/tako_p2.png","answerPict":"","rand":true,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"2","mode":"renda","quiztype":"運動神経伝達力","beforeTxt":"","beforeImg":"images/run0.png","beforeMusic":"","beforeTime":"","question":"連打して！","image":"images/run1.png","music":"","image2":"images/run2.png","image2time":"","options":[{"text":"連打!"},{"text":""},{"text":""},{"text":""}],"correct":"","answerPict":"","rand":false,"answertime":5000,"answerstart":5000,"perfect":50,"excellent":40,"great":30,"good":20,"safe":10,"banner":""},
  {"stage":"3","mode":"","quiztype":"記憶力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"今何問目？","image":"","music":"","image2":"","image2time":"","options":[{"text":"12"},{"text":"14"},{"text":"16"},{"text":"17"}],"correct":"17","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"3","mode":"kioku","quiztype":"記憶力","beforeTxt":"画像を覚えて！","beforeImg":"images/animals.png","beforeMusic":"","beforeTime":"4000","question":"野鳥の数は？","image":"","music":"","image2":"","image2time":"","options":[{"text":"0"},{"text":"1"},{"text":"2"},{"text":"3"}],"correct":"2","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"3","mode":"","quiztype":"注意力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"文字数が多いのは？","image":"images/words.png","music":"","image2":"","image2time":"","options":[{"text":"T"},{"text":"M"},{"text":"Y"},{"text":"H"}],"correct":"T","answerPict":"","rand":true,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"3","mode":"","quiztype":"空間認識力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"バスの進行方向は？","image":"images/bus_right.png","music":"","image2":"","image2time":"","options":[{"text":"左"},{"text":"右"},{"text":""},{"text":""}],"correct":"右","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"3","mode":"renda","quiztype":"運動神経伝達力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"連打して！","image":"images/karate_left.png","music":"","image2":"images/karate_right.png","image2time":"","options":[{"text":"連打!"},{"text":""},{"text":""},{"text":""}],"correct":"","answerPict":"","rand":false,"answertime":5000,"answerstart":5000,"perfect":50,"excellent":40,"great":30,"good":20,"safe":10,"banner":""},
  {"stage":"3","mode":"","quiztype":"色彩認識力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"この中で一番小さい四角形は？","image":"images/shikaku.png","music":"","image2":"","image2time":"","options":[{"text":"黒"},{"text":"緑"},{"text":"赤"},{"text":"紫"}],"correct":"黒","answerPict":"","rand":true,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"3","mode":"","quiztype":"形状判断力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"あてはまらないのは？","image":"images/plats.png","music":"","image2":"","image2time":"","options":[{"text":"images/plats_p1.png"},{"text":"images/plats_p2.png"},{"text":"images/plats_p3.png"},{"text":"images/plats_p4.png"}],"correct":"images/plats_p1.png","answerPict":"","rand":true,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"3","mode":"","quiztype":"パターン認識力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"あてはまるのは？","image":"images/num2.png","music":"","image2":"","image2time":"","options":[{"text":"1"},{"text":"2"},{"text":"3"},{"text":"4"}],"correct":"1","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"4","mode":"","quiztype":"昭和力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"若いのは？","image":"","music":"","image2":"","image2time":"","options":[{"text":"images/mickey1.png"},{"text":"images/mickey2.png"},{"text":"images/mickey3.png"},{"text":""}],"correct":"images/mickey2.png","answerPict":"","rand":true,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"4","mode":"","quiztype":"昭和力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"1978年の​日本レコード大賞は？​","image":"","music":"","image2":"","image2time":"","options":[{"text":"images/record1.png"},{"text":"images/record2.png"},{"text":"images/record3.png"},{"text":"images/record4.png"}],"correct":"images/record1.png","answerPict":"","rand":true,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"4","mode":"","quiztype":"昭和力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"聖子ちゃんは？","image":"","music":"","image2":"","image2time":"","options":[{"text":"images/seiko1.png"},{"text":"images/seiko2.png"},{"text":"images/seiko3.png"},{"text":""}],"correct":"images/seiko2.png","answerPict":"","rand":true,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"4","mode":"","quiztype":"昭和力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"1974年の​新語・流行語大賞は？","image":"","music":"","image2":"","image2time":"","options":[{"text":"あっと​驚く<br>​タメゴロー"},{"text":"オジン オバン"},{"text":"普通の​女の​子に<br>​戻りたい"},{"text":"巨人軍は​永久に<br>​不滅です"}],"correct":"巨人軍は​永久に<br>​不滅です","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"4","mode":"mikiri","quiztype":"運動神経伝達力","beforeTxt":"もぐらが出たらたたけ！","beforeImg":"images/mogudot1.png","beforeMusic":"","beforeTime":"7000","question":"もぐらが出たらたたけ！","image":"images/mogudot2.png","music":"","image2":"","image2time":"","options":[{"text":"左"},{"text":"右"},{"text":""},{"text":""}],"correct":"右","answerPict":"","rand":false,"answertime":4000,"answerstart":4000,"perfect":3500,"excellent":3000,"great":2000,"good":1000,"safe":0,"banner":""},
  {"stage":"4","mode":"","quiztype":"昭和力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"マフラーは何色？","image":"images/009.png","music":"","image2":"","image2time":"","options":[{"text":"赤"},{"text":"黄"},{"text":"青"},{"text":"紫"}],"correct":"赤","answerPict":"","rand":true,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"4","mode":"","quiztype":"昭和力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"最終回「□□□陽はまた昇る」","image":"images/triton.png","music":"","image2":"","image2time":"","options":[{"text":"images/triton_a.png"},{"text":"images/triton_b.png"},{"text":"images/triton_c.png"},{"text":""}],"correct":"images/triton_a.png","answerPict":"","rand":true,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"4","mode":"","quiztype":"昭和力","beforeTxt":"まずは音を聞いて！","beforeImg":"images/kiite.png","beforeMusic":"seven","beforeTime":"9500","question":"セブンって何回言った？","image":"","music":"","image2":"","image2time":"","options":[{"text":"5"},{"text":"6"},{"text":"7"},{"text":"8"}],"correct":"6","answerPict":"","rand":false,"answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0,"banner":""},
  {"stage":"5","mode":"","quiztype":"注意力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"じゃんけんで負けて！","image":"images/hiroshi.png","music":"","image2":"","image2time":"","options":[{"text":"images/ba-chan-tyoki.png"},{"text":"images/ba-chan-paa.png"},{"text":""},{"text":""}],"correct":"images/ba-chan-paa.png","answerPict":"","rand":true,"answertime":10000,"answerstart":10000,"perfect":9500,"excellent":7500,"great":5000,"good":2500,"safe":0,"banner":"images/banner_arima.png"},
  {"stage":"5","mode":"","quiztype":"これ何力？","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"葉子ちゃんは？","image":"","music":"","image2":"","image2time":"","options":[{"text":"images/yoko1.png"},{"text":"images/yoko2.png"},{"text":"images/yoko3.png"},{"text":""}],"correct":"images/yoko1.png","answerPict":"","rand":true,"answertime":10000,"answerstart":10000,"perfect":9500,"excellent":7500,"great":5000,"good":2500,"safe":0,"banner":"images/banner_komaccha.png"},
  {"stage":"5","mode":"","quiztype":"記憶力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"誰？","image":"images/naomasa.png","music":"","image2":"","image2time":"","options":[{"text":"直正"},{"text":"直弘"},{"text":"直大"},{"text":"直虎"}],"correct":"直正","answerPict":"","rand":true,"answertime":10000,"answerstart":10000,"perfect":9500,"excellent":7500,"great":5000,"good":2500,"safe":0,"banner":"images/banner_nabeshima.png"},
  {"stage":"5","mode":"","quiztype":"形状判断力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"若いのは？","image":"","music":"","image2":"","image2time":"","options":[{"text":"images/kaeru.png"},{"text":"images/penguin.png"},{"text":""},{"text":""}],"correct":"images/penguin.png","answerPict":"","rand":true,"answertime":10000,"answerstart":10000,"perfect":9500,"excellent":7500,"great":5000,"good":2500,"safe":0,"banner":"images/banner_michi2.png"},
  {"stage":"5","mode":"","quiztype":"記憶力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"電車の進行方向は？","image":"images/soubu.png","music":"","image2":"","image2time":"","options":[{"text":"中野"},{"text":"三鷹"},{"text":"千葉"},{"text":"津田沼"}],"correct":"中野","answerPict":"","rand":true,"answertime":10000,"answerstart":10000,"perfect":9500,"excellent":7500,"great":5000,"good":2500,"safe":0,"banner":"images/banner_msd.png"},
  {"stage":"5","mode":"kioku","quiztype":"記憶力","beforeTxt":"画像を覚えて！","beforeImg":"images/picos.png","beforeMusic":"","beforeTime":"4000","question":"野鳥の数は？","image":"","music":"","image2":"","image2time":"","options":[{"text":"0"},{"text":"3"},{"text":"5"},{"text":"7"}],"correct":"0","answerPict":"images/picocomment.png","rand":false,"answertime":10000,"answerstart":10000,"perfect":9500,"excellent":7500,"great":5000,"good":2500,"safe":0,"banner":"images/banner_michi1.png"},
  {"stage":"5","mode":"","quiztype":"注意力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"じゃんけんで勝って！","image":"images/ken_paa.png","music":"","image2":"","image2time":"","options":[{"text":"images/nao_goo.png"},{"text":"images/nao_tyoki.png"},{"text":""},{"text":""}],"correct":"images/nao_tyoki.png","answerPict":"","rand":true,"answertime":10000,"answerstart":10000,"perfect":9500,"excellent":7500,"great":5000,"good":2500,"safe":0,"banner":"images/banner_naoken.png"},
  {"stage":"5","mode":"","quiztype":"記憶力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"ポッポはどれ？","image":"","music":"","image2":"","image2time":"","options":[{"text":"images/poke_koko.png"},{"text":"images/poke_oni.png"},{"text":"images/poke_suba.png"},{"text":"images/poke_mada.png"}],"correct":"images/poke_mada.png","answerPict":"","rand":true,"answertime":10000,"answerstart":10000,"perfect":9500,"excellent":7500,"great":5000,"good":2500,"safe":0,"banner":"images/banner_ff14.png"},
  {"stage":"5","mode":"","quiztype":"これ何力？","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"あてはまるのは？<br><br>□法も筆の誤り<br>□法筆を選ばず","image":"","music":"","image2":"","image2time":"","options":[{"text":"images/hiroshi1.png"},{"text":"images/hiroshi2.png"},{"text":"images/hiroshi3.png"},{"text":"images/hiroshi4.png"}],"correct":"images/hiroshi1.png","answerPict":"","rand":true,"answertime":10000,"answerstart":10000,"perfect":9500,"excellent":7500,"great":5000,"good":2500,"safe":0,"banner":"images/banner_pgo.png"},
  {"stage":"5","mode":"renda","quiztype":"運動神経伝達力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"連打して！","image":"images/pico_up.png","music":"","image2":"images/pico_down.png","image2time":"","options":[{"text":"連打!"},{"text":""},{"text":""},{"text":""}],"correct":"","answerPict":"","rand":false,"answertime":5000,"answerstart":5000,"perfect":50,"excellent":40,"great":30,"good":20,"safe":10,"banner":"images/banner_michi3.png"},
  {"stage":"5","mode":"mikiri","quiztype":"運動神経伝達力","beforeTxt":"もぐらが出たらたたけ！","beforeImg":"images/anagachi_0.png","beforeMusic":"","beforeTime":"13000","question":"もぐらが出たらたたけ！","image":"images/anagachi_mogu.png","music":"","image2":"","image2time":"","options":[{"text":"左上"},{"text":"右上"},{"text":"左下"},{"text":"右下"}],"correct":"左下","answerPict":"","rand":false,"answertime":4000,"answerstart":4000,"perfect":3500,"excellent":3000,"great":2000,"good":1000,"safe":0,"banner":"images/banner_anagachi1.png"},
  {"stage":"5","mode":"","quiztype":"聴力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"みちよって何回言った？","image":"images/kiite.png","music":"","image2":"","image2time":"","options":[{"text":"33"},{"text":"34"},{"text":"35"},{"text":"36"}],"correct":"34","answerPict":"","rand":false,"answertime":10000,"answerstart":10000,"perfect":9500,"excellent":7500,"great":5000,"good":2500,"safe":0,"banner":"images/banner_suno.png"},
  {"stage":"5","mode":"","quiztype":"最終確認","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"あなたは<br>吉田道代<br>ですね？","image":"","music":"","image2":"","image2time":"","options":[{"text":"はい"},{"text":"はい"},{"text":"はい"},{"text":"はい"}],"correct":"はい","answerPict":"","rand":false,"answertime":10000,"answerstart":10000,"perfect":9500,"excellent":7500,"great":5000,"good":2500,"safe":0,"banner":""},
];

// --- ステージ情報 ---
const stageData=[
  {"stage":"0", "loadMsg":"準備しています…", "startMsg":"脳トレの前に、質問です", "banner":"images/banner_goo.png"}, 
  {"stage":"1", "loadMsg":"問題を作成しています…", "startMsg":"AI脳トレ スタート！", "banner":"images/banner_kddi.png"},
  {"stage":"2", "loadMsg":"あなたの回答を分析しています…", "startMsg":"少しレベルを上げます！", "banner":"images/banner_servicenow.jpg"},
  {"stage":"3", "loadMsg":"さらに分析しています…", "startMsg":"やりますね！さらにレベルアップ！", "banner":"images/banner_dp.png"},
  {"stage":"4", "loadMsg":"あなたにあわせて調整しています…", "startMsg":"推定年代の問題です", "banner":"images/banner_mitsu.jpg"},
  {"stage":"5", "loadMsg":"回答データ解析中…", "startMsg":"最終ステージです", "banner":"images/banner_trans.jpg"},
]

var isHiroshi = false;
var kasoku = false;

function checkOrientation() {
  const isLandscape = window.matchMedia('(orientation: landscape)').matches;
  document.body.classList.toggle('landscape', isLandscape);
}
window.addEventListener('resize', checkOrientation);
</script>
</head>
<body>

<div id="first-confirm" >
  <span class="first-confirm-title">AI脳トレへようこそ</span>
  <img class="first-confirm-image" src="images/image.png" />
  <div class="sentence">
    このアプリはあなたの回答をもとに<br>
    <span class="highlight">あなただけの脳トレ</span>をAIが作成します。
  </div>
  <hr class="divider">
  <div class="audio-info">
    <img src="images/imageSound.png" class="icon" alt="音声アイコン">
    <div class="audio-text">
      <div>一部の問題では<br>音声を使用します。<br><span class="highlight">音量にご注意</span>ください。</div>
    </div>
  </div>
  <hr class="divider">
  <div id="first-confirm-buttons" >
    <button id='start' onclick="init();">START</button>
    <button id='back' onclick="back(this);">戻る</button>
  </div>
</div>

<div class="cutin">
  <div class="cutin-content">
    <img src="images/batsu.png" class="cutin-img" style="display:none;">
    <svg id="countSvg" >
      <text id="cutinCountTxtBG" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
            fill="url(#white)" stroke="#fff" stroke-width="17" stroke-linejoin="round">
        0.32 sec
      </text>
      <!-- メイン文字 -->
      <text id="cutinCountTxt" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
            fill="url(#white)" stroke="#333" stroke-width="15" stroke-linejoin="round">
        0.32 sec
      </text>
      <!-- 光沢ハイライト -->
      <text id="cutinCountTxtHighlight" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
            fill="url(#white)" stroke="rgba(255,255,255,1)" stroke-width="1">
        0.32 sec
      </text>
    </svg>
    <svg id="rankSvg" >
      <defs>
        <!-- 各グラデーション定義 -->
        <linearGradient id="pinkgold" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#ffe6f2"/>
          <stop offset="25%" stop-color="#ffb3d9"/>
          <stop offset="50%" stop-color="#ff99cc"/>
          <stop offset="75%" stop-color="#ff66b3"/>
          <stop offset="100%" stop-color="#ffd6e6"/>
        </linearGradient>
      
        <linearGradient id="rainbow" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#ff8080"/>
          <stop offset="16%" stop-color="#ffc080"/>
          <stop offset="33%" stop-color="#ffff80"/>
          <stop offset="50%" stop-color="#80ff80"/>
          <stop offset="66%" stop-color="#80ffff"/>
          <stop offset="83%" stop-color="#8080ff"/>
          <stop offset="100%" stop-color="#ff80ff"/>
        </linearGradient>

        <linearGradient id="gold" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#fff2a8"/>
          <stop offset="30%" stop-color="#ffd700"/>
          <stop offset="60%" stop-color="#caa400"/>
          <stop offset="100%" stop-color="#fff4b3"/>
        </linearGradient>

        <linearGradient id="silver" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#ffffff"/>
          <stop offset="30%" stop-color="#d9d9d9"/>
          <stop offset="60%" stop-color="#b0b0b0"/>
          <stop offset="100%" stop-color="#e6e6e6"/>
        </linearGradient>

        <linearGradient id="bronze" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#ffe0b3"/>
          <stop offset="30%" stop-color="#cd7f32"/>
          <stop offset="60%" stop-color="#8b4513"/>
          <stop offset="100%" stop-color="#ffcc99"/>
        </linearGradient>
        
        <linearGradient id="blue" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#e0f7ff"/>
          <stop offset="30%" stop-color="#66ccff"/>
          <stop offset="60%" stop-color="#3399ff"/>
          <stop offset="100%" stop-color="#0066cc"/>
        </linearGradient>
        
        <linearGradient id="white" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#fff"/>
          <stop offset="49%" stop-color="#fff"/>
          <stop offset="51%" stop-color="#B4FFFF"/>
          <stop offset="100%" stop-color="#B4FFFF"/>
        </linearGradient>
      </defs>

      <text id="rankTextBG" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
            fill="url(#rainbow)" stroke="#fff" stroke-width="12" stroke-linejoin="round">
        EXCELLENT!
      </text>
      <!-- メイン文字 -->
      <text id="rankText" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
            fill="url(#rainbow)" stroke="#333" stroke-width="10" stroke-linejoin="round">
        EXCELLENT!
      </text>
      <!-- 光沢ハイライト -->
      <text id="rankTextHighlight" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
            fill="url(#rainbow)" stroke="rgba(255,255,255,1)" stroke-width="1">
        EXCELLENT!
      </text>
    </svg>
    <div class="cutin-score">スコア&nbsp;<span id="cutinScoreValue">9999</span></div>
  </div>
</div>

<div id="stage-overlay" style="display:none;">
  <div id="stage-overlay-title" >
    <div id="stage-title" >STAGE 1</div>
    <div id="stage-msg" ></div>
    <div class="count-number" id="countNum" >3</div>
  </div>
</div>
<div id="stage-overlay-loading" style="display:none;" >
  <div id="img-wrap" class="img-wrap">
    <img id="loading-logo" src="images/logo_icon_trans.png" alt="ロゴアイコン" class="stage-overlay-img" oncontextmenu="return false;" draggable="false">
  </div>
  <div id="loading-msg" ></div>
  <div class="loading-bar" id="loadingBar" ><div class="loading-progress" id="stageProgress"></div></div>
</div>

<div class="container" >
  <!-- === ステージ情報バー === -->
  <div id="stage-info" class="stage-info">
    <div class="stage-left" id="stage-info-title">STAGE 1</div>
    <div class="stage-center">
      <div class="stage-progress"></div>
    </div>
    <div class="stage-right">
      <span class="score-label">スコア</span>
      <span class="score-value">00000</span>
    </div>
  </div>
  <div class="quiz-header" id="quiz-header" style="display:none;">
    <span id="quiz-no"></span>
  </div>
  <div class="question-box" id="question" style="display:none;"></div>
  <div class="timer-container" id="timer-container" style="display:none;">
    <div class="timer-label">TIME</div>
    <div class="timer-bar"><div class="timer-progress" id="timerProgress"></div></div>
  </div>
  <div class="buttons" id="buttons" style="display:none;"></div>
  <div class="banner" id="banner" style="display:none;">
    <image src="images/banner_goo.png" />
  </div>
  <div id="sukaText">スカ！</div>
</div>

<script>
checkOrientation();

document.getElementById('banner').addEventListener("click", () => {

  if(!testMode){
    return;
  }

  kasoku=true;
  stopTimer();
  se_re.pause();
  se_brazirian.pause();
  count=0;
  quizFinaly();
});

const loading=document.getElementById('loading-overlay');
const loadingProgress=document.getElementById('loadingProgress');

// JSON内のすべての画像URLを抽出してプリロード
window.addEventListener("load", () => {

  setTimeout(() => {
    //初回確認を表示し、裏でプリロード
    document.getElementById('first-confirm').classList.add('show');
    document.body.classList.add('grid-restart');
    initButtonTouchEvents();
  }, 0);

  //音声プリロード
  preloadSounds(['count','point','seikai','huseikai', 'lvup']);

  const imageUrls = new Set();
  imageUrls.add('images/maru.png');
  imageUrls.add('images/batsu.png');
  imageUrls.add('images/renda.png');
  imageUrls.add('images/mikiri.png');
  imageUrls.add('images/mikiri_press.png');
  imageUrls.add('images/anagachi_1.png');
  imageUrls.add('images/anagachi_2.png');
  imageUrls.add('images/anagachi_4.png');
  imageUrls.add('images/anagachi_5.png');
  //ボタン用
  
  quizData.forEach(q => {
    if (q.beforeImg) imageUrls.add(q.beforeImg);
    if (q.image) imageUrls.add(q.image);
    if (q.image2) imageUrls.add(q.image2);
    if (q.answerPict) imageUrls.add(q.answerPict);
    q.options?.forEach(opt => {
      if (opt.text.endsWith('.png')) imageUrls.add(opt.text);
    });
    if (q.banner) imageUrls.add(q.banner);
  });

  //みちよ画像
  imageUrls.add(`images/michiyo.gif`);
  for (let i = 0; i <= 30; i++) {
    imageUrls.add(`images/logo_michi_${i}.png`);
  }
  imageUrls.add(`images/logo_michi_99.png`);

  imageUrls.forEach(src => {
    const img = new Image();
    img.src = src;
  });
});

function back(btn){
  btn.classList.add('pressed');

  document.getElementById('first-confirm').classList.remove('show');
  void document.body.offsetWidth; // 再生リセット
  document.getElementById('first-confirm').classList.add('hide');
  document.body.classList.add('hide');

  setTimeout(()=>{
    location.href = 'start.html';
  },1000);
}

let currentIndex=0;
let answered=false;
let timerTimeout;
let startTime, endTime;
let timeLeftMs = 0;
let tapTime = 0;

const quizNo=document.getElementById('quiz-no');
const questionBox=document.getElementById('question');
const buttonsDiv=document.getElementById('buttons');
const timerLabel = document.querySelector('.timer-label');
const timerBar = document.querySelector('.timer-bar');
const timerProgress=document.getElementById('timerProgress');

let timerFrame;

function hideTimer(){
  timerLabel.style.display = 'none';
  timerBar.style.display = 'none';
}

function startTimer(){
  const duration = q.answertime;
  startTime = Date.now();
  endTime = startTime + duration; 
  cancelAnimationFrame(timerFrame); // 前のループを止める
  
  timerLabel.style.display = '';
  timerProgress.style.transition = "none";
  timerProgress.style.width = "100%";
  timerBar.style.display = '';
  void timerProgress.offsetWidth;

  function update(now){
    const elapsed = now - start;
    const progress = Math.max(0, 1 - elapsed / duration);
    timerProgress.style.width = (progress * 100) + "%";

    // 緑→黄→赤 のグラデーション補間
    const color = getProgressColor(progress);
    timerProgress.style.backgroundColor = color;

    if (!answered) {
      if (elapsed < duration){
        timerFrame = requestAnimationFrame(update);
      } else {
      
        if(q.mode=='renda'){
          rendaResult();
        }else{
          if(!testMode && nowStage.stage!=0){
            handleAnswer(null);
          }
        }
      }
    }
  }
  
  const start = performance.now();
  timerFrame = requestAnimationFrame(update);
}

function getProgressColor(progress) {
  if (progress > q.great / q.answertime) {
    return "#a8e6a1"; // パステルグリーン
  } else if (progress > q.good / q.answertime) {
    return "#fff59d"; // パステルイエロー
  } else {
    return "#ff9e9e"; // パステルレッド
  }
}

function stopTimer() {
  clearTimeout(timerTimeout);
  const now = Date.now();
  timeLeftMs = Math.max(endTime - now, 0); // 残りミリ秒
  tapTime = Math.max(now - startTime, 0); // 経過ミリ秒

  const computedStyle = window.getComputedStyle(timerProgress);
  const widthPx = parseFloat(computedStyle.width);
  const parentWidth = timerProgress.parentElement.offsetWidth;
  const widthPercent = (widthPx / parentWidth) * 100;

  timerProgress.style.transition = "none";
  timerProgress.style.width = `${widthPercent}%`;
}


//2枚目の画像切替用タイマー
let imageSwitchTimer;

let q;
let rendaCount;


//出題処理
function showQuestion(){
  answered=false;
  kasoku=false;

  startTime = 0;
  
  clearTimeout(imageSwitchTimer);
  
  q=quizData[currentIndex];
  quizNo.innerHTML="Q" + (currentIndex - stageData[0].count + 1) + "　" + q.quiztype;
  
  if(nowStage.stage==0){
    quizNo.innerHTML=q.quiztype;
    hideTimer();
  }else if(q.question=="今何問目？"){
    quizNo.innerHTML="Q？" + "　" + q.quiztype;
  }

  if(q.banner!=''){
    changeBanner(q.banner);
  }
  
  rendaCount = 0;
  
  if(q.mode=='renda'){
    var rendaImg = q.image;
    if(q.beforeImg != ''){
      rendaImg = q.beforeImg;
    }
    questionBox.innerHTML=q.question + (q.image?`<br><img src="${rendaImg}" class="quiz-img">`:"");
    hideTimer();
    buttonsDiv.innerHTML="";
    buttonsDiv.className = 'buttons';
    
    startQuizCountdown();

  }else if(q.beforeTxt != '' || q.beforeImg != ''){
    questionBox.innerHTML=q.beforeTxt + (q.beforeImg?`<br><img id="quiz-img" src="${q.beforeImg}" class="quiz-img">`:"");
    hideTimer();
    
    if(q.mode=='mikiri'){
      setButtons();
    }else{
      buttonsDiv.innerHTML="";
      buttonsDiv.className = 'buttons';
    }

    if(q.beforeMusic != ''){
      playSound(q.beforeMusic);
    }
    
    //あなガチ！特別対応
    if(q.beforeImg == 'images/anagachi_0.png'){
      setTimeout(()=>{document.getElementById('quiz-img').src = 'images/anagachi_1.png'}, 2000);
      setTimeout(()=>{document.getElementById('quiz-img').src = 'images/anagachi_0.png'}, 4500);
      setTimeout(()=>{changeBanner('images/banner_anagachi2.png')}, 4500);
      setTimeout(()=>{document.getElementById('quiz-img').src = 'images/anagachi_2.png'}, 5000);
      setTimeout(()=>{document.getElementById('quiz-img').src = 'images/anagachi_0.png'}, 6500);
      setTimeout(()=>{changeBanner('images/banner_anagachi3.png')}, 6500);
      setTimeout(()=>{document.getElementById('quiz-img').src = 'images/anagachi_4.png'}, 7500);
      setTimeout(()=>{document.getElementById('quiz-img').src = 'images/anagachi_0.png'}, 9500);
      setTimeout(()=>{changeBanner('images/banner_anagachi4.png')}, 9500);
      setTimeout(()=>{document.getElementById('quiz-img').src = 'images/anagachi_5.png'}, 10000);
      setTimeout(()=>{document.getElementById('quiz-img').src = 'images/anagachi_0.png'}, 12500);
      setTimeout(()=>{changeBanner('images/banner_anagachi5.png')}, 12500);
      setTimeout(()=>{changeBanner('images/banner_anagachi6.png')}, 13000);
    }

    setTimeout(()=>{
      if(q.mode=='kioku'){
        startQuizCountdown();
      }else{
        showQuestionMain();
      }
    },q.beforeTime);
    
  }else{
    showQuestionMain();
  }
}

//出題時カウントダウン処理(連打用)
let quizCountNum;
let quizCountdownCount=3;

function startQuizCountdown(){
  buttonsDiv.innerHTML='<div class="count-number" id="quizCountNum" >3</div>';
  quizCountNum = document.querySelector('#quizCountNum');
  quizCountdownCount=3;
  showQuizCountdown();
}

function showQuizCountdown(){
  quizCountNum.textContent=quizCountdownCount;
  quizCountNum.style.opacity='1';
  quizCountNum.style.animation='moveUp 0.7s ease';
  playSound('count');
  
  quizCountNum.addEventListener('animationend',()=>{
    quizCountNum.style.animation='none';
    quizCountNum.style.opacity='0';
    quizCountdownCount--;
  
    if(quizCountdownCount>0){
      setTimeout(showQuizCountdown,150);
    }else{
      quizCountNum.style.opacity='0';
      
      setTimeout(()=>{
        showQuestionMain();
      },500);
    }
  },{once:true});
}

function showQuestionMain(){

  var qText = q.question;

  if(q.quiztype=='質問3'){
    qText = q.question.replace('性別年代', seibetsuNenrei);
  }

  questionBox.innerHTML=qText + (q.image?`<br><img src="${q.image}" class="quiz-img">`:"");
  setButtons();

  if(q.mode=='renda'){
    setRenda();
    if(q.image=='images/pico_up.png'){
      playSound('picovoice', 0.4)
    }else{
      playSound('brazirian', 0.4)
    }
  }
  
  initButtonTouchEvents();
  if(nowStage.stage > 0){
    startTimer();
  }
  if(q.music && q.music !=''){
    playSound(q.music);
  }
  
  if (q.image2 && q.image2time) {
    const switchMs = q.image2time;
    imageSwitchTimer = setTimeout(() => {
      const img = questionBox.querySelector('.quiz-img');
      if (img && !answered) {
        img.src = q.image2;
      }
    }, switchMs);
  }
}

function setButtons(){
  buttonsDiv.innerHTML="";
  buttonsDiv.className = 'buttons '+ q.mode;

  if(q.rand==true){
    q.options.sort(() => Math.random() - 0.5);
  }
  
  q.options.forEach((opt, i) => {
    if(opt.text != ''){
      const btn=document.createElement('button');

      if (opt.text.endsWith('.png')) {
        btn.style.backgroundImage = `url(${opt.text})`;
        btn.textContent = '';
        btn.classList.add('imgbtn');
      } else {
        btn.innerHTML = opt.text;

        if(opt.text.length > 5){
          buttonsDiv.classList.add('long-word');
        }else if(opt.text.length>=3){
          buttonsDiv.classList.add('three-word');
        }
      }
      
      btn.onclick=()=> {
        if(q.mode=='renda'){
          handleRenda(opt.text);
        }else if(nowStage.stage==0){
          handleAnswer(opt.text);
        }else if(startTime==0){
          suka();
        }else{
          handleAnswer(opt.text);
        }
      };
      
      buttonsDiv.appendChild(btn);
    }
  });
  // ボタン数でクラスを切り替え
  const count = buttonsDiv.querySelectorAll('button').length;
  buttonsDiv.classList.add(count <= 3 ? 'one-row' : 'two-row');
  //buttonsDiv.className = 'buttons ' + (count <= 3 ? 'one-row ' : 'two-row ') + q.mode;
}

function suka(){
  addScore(-100);

  const sukaText = document.getElementById('sukaText');
  sukaText.style.display = 'block';

  playSound('huseikai');

  setTimeout(() => {
    sukaText.style.display = 'none';
    Array.from(buttonsDiv.children).forEach(btn=>{
      btn.classList.remove('pressed');
    });
  }, 500);
}

function setRenda(){

  rendaCount = 0;

  questionBox.innerHTML=q.question + `<br><img src="${q.image}" class="quiz-img"><div id="tap-gauge"><div id="tap-count">0</div><div id="tap-fill"></div></div>`
  document.getElementById('tap-fill').style.display = 'none';
  buttonsDiv.innerHTML="";
  q.options.forEach((opt, i) => {
    if(opt.text != ''){
      const btn=document.createElement('button');
      btn.innerHTML=opt.text;
      
      btn.onclick=()=> {
        handleRenda(opt.text);
      };
      
      buttonsDiv.appendChild(btn);
    }
  });
  

}

function handleRenda(selected){

  //連打するので押したボタンはすぐ引っ込む
  setTimeout(() => {
    Array.from(buttonsDiv.children).forEach(btn=>{
      btn.classList.remove('pressed');
    });
  }, 50);
  
  if(answered) return;
      
  rendaCount++;
          
  // シェイク演出
  const img = questionBox.querySelector('.quiz-img');
  img.classList.remove('shake');
  void img.offsetWidth; // ← 強制リフローで再適用可能に
  img.classList.add('shake');

  //playSound('hit');
    
  if (q.image2) {
    if(rendaCount % 2 === 0){
      img.src = q.image;
    }else{
      img.src = q.image2;
    }
  }
  
  var bg = document.getElementById('tap-gauge');
  var fill = document.getElementById('tap-fill');
  var count = document.getElementById('tap-count');

  fill.style.display = '';
  
  var percent;
  
  if(q.perfect <= rendaCount){
    percent = 1;
    fill.style.background = 'var(--pastel-red)';
  }else if(q.excellent < rendaCount){
    percent = (rendaCount - q.excellent) / (q.perfect - q.excellent);
    fill.style.background = 'var(--pastel-red)';
    bg.style.background = 'var(--pastel-orange)';
  }else if(q.great < rendaCount){
    percent = (rendaCount - q.great) / (q.excellent - q.great);
    fill.style.background = 'var(--pastel-orange)';
    bg.style.background = 'var(--pastel-yellow)';
  }else if(q.good < rendaCount){
    percent = (rendaCount - q.good) / (q.great - q.good);
    fill.style.background = 'var(--pastel-yellow)';
    bg.style.background = 'var(--pastel-green)';
  }else if(q.safe < rendaCount){
    percent = (rendaCount - q.safe) / (q.good - q.safe);
    fill.style.background = 'var(--pastel-green)';
    bg.style.background = 'var(--pastel-blue)';
  }else{
    percent = rendaCount / q.safe;
    fill.style.background = 'var(--pastel-blue)';
    bg.style.background = '#fff';
  }
  
  fill.style.height = percent * 100 + "%";
  count.textContent = rendaCount;

  if(q.perfect <= rendaCount){
    rendaResult();
  }
}


const rankTextBG = document.getElementById('rankTextBG');
const rankText = document.getElementById('rankText');
const rankHighlight = document.getElementById('rankTextHighlight');
const cutinScoreValue=document.getElementById('cutinScoreValue');
var seibetsuNenrei = "";

function handleAnswer(selected){

  if(answered) return;
  answered=true;
  stopTimer();
  const q=quizData[currentIndex];
  const isCorrect=(selected===q.correct);
  Array.from(buttonsDiv.children).forEach(btn=>{
    if(btn.textContent.includes(selected)) btn.classList.add('pressed');
  });

  if(nowStage.stage==0){

    if(selected=='男性'){
      isHiroshi = true;
    }

    if(q.quiztype=='質問1'){
      seibetsuNenrei = selected + "<br>";
    }else if(q.quiztype=='質問2'){
      if(selected=='～20'){
        seibetsuNenrei+="～20歳";
      }else if(selected=='21～40'){
        seibetsuNenrei+="21歳～40歳";
      }else if(selected=='41～60'){
        seibetsuNenrei+="41歳～60歳";
      }else if(selected=='61～'){
        seibetsuNenrei+="60歳～";
      }
    }

    setTimeout(() => {
      if(q.quiztype=='質問3' && selected=='いいえ'){
        isHiroshi = false;
        currentIndex=0;
        stageQuizIdx=0;
        showQuestion();
      }else{
        quizFinaly();
      }
    }, 500);
    return;
  }

  se_re.pause();//ダサいが

  if(isCorrect){
    playSound('seikai');
    //playSound('point', 0.5);
  }else{
    playSound('huseikai');
  }
  
  if(isCorrect && q.answerstart > timeLeftMs){
    var gained = 0;
    var cutinTitle = "";
    
    if(q.perfect < timeLeftMs){
      gained = 600;
      cutinTitle = "PERFECT!!"
      setRankStyle('pinkgold');
      
    }else if(q.excellent < timeLeftMs){
      //ポイント＝評価基礎点＋評価倍率×評価範囲の​下限超過時間​（％）​
      gained = 500 + Math.floor(5 * (timeLeftMs - q.excellent) / q.answerstart * 100);
      cutinTitle = "EXCELLENT!"
      setRankStyle('rainbow');
      
    }else if(q.great < timeLeftMs){
      gained = 300 + Math.floor(3 * (timeLeftMs - q.great) / q.answerstart * 100);
      cutinTitle = "GREAT!"
      setRankStyle('gold');
      
    }else if(q.good < timeLeftMs){
      gained = 200 + Math.floor(2 * (timeLeftMs - q.good) / q.answerstart * 100);
      cutinTitle = "GOOD"
      setRankStyle('silver');
      
    }else{
      gained = 100 + Math.floor(1 * timeLeftMs / q.answerstart * 100);
      cutinTitle = "SAFE"
      setRankStyle('bronze');
      
    }
    
    addScore(gained);
    
    showCutIn(isCorrect, cutinTitle);
  }else{
    
    cutinScoreValue.textContent = '0';
    showCutIn(false, "BAD");
    setRankStyle('blue');
    
  }
}

function rendaResult(){

  se_brazirian.pause();
  se_picovoice.pause();

  answered=true;
  stopTimer();
  const q=quizData[currentIndex];
  
  if(q.perfect <= rendaCount){
    gained = 600;
    cutinTitle = "PERFECT!!"
    setRankStyle('pinkgold');
    
  }else if(q.excellent <= rendaCount){
    //ポイント＝評価基礎点＋評価倍率×評価範囲の​下限超過時間​（％）​
    gained = 500 + Math.floor(5 * (rendaCount - q.excellent) / (q.perfect - q.excellent));
    cutinTitle = "EXCELLENT!"
    setRankStyle('rainbow');
    
  }else if(q.great <= rendaCount){
    gained = 300 + Math.floor(3 * (rendaCount - q.great) / (q.excellent - q.great));
    cutinTitle = "GREAT!"
    setRankStyle('gold');
    
  }else if(q.good <= rendaCount){
    gained = 200 + Math.floor(2 * (rendaCount - q.good) / (q.great - q.good));
    cutinTitle = "GOOD"
    setRankStyle('silver');
    
  }else if(q.safe <= rendaCount){
    gained = 100 + Math.floor(1 * (rendaCount - q.safe) / (q.good - q.safe));
    cutinTitle = "SAFE"
    setRankStyle('bronze');
    
  }else{
    gained = 0;
    cutinTitle = "BAD"
    setRankStyle('blue');
  }

  if(cutinTitle != "BAD"){
    playSound('seikai');
    //playSound('point', 0.5);
  }else{
    playSound('huseikai');
  }
  
  addScore(gained);
  
  showCutIn(true, cutinTitle);
}

let score = 0;
let displayScore = 0;
const scoreEl = document.querySelector('.score-value');

function addScore(amount) {
  const start = displayScore;
  score = Math.max(0, score + amount); // マイナスにならないよう制限

  const step = () => {
    const diff = score - displayScore;
    if (diff !== 0) {
      displayScore += diff > 0 ? Math.ceil(diff / 10) : Math.floor(diff / 10);
      // 1万以下は0埋め5桁表示
      scoreEl.textContent = score <= 99999
        ? displayScore.toString().padStart(5, '0')
        : displayScore.toString();
      cutinScoreValue.textContent = (displayScore - start).toString();
      requestAnimationFrame(step);
    } else {
      scoreEl.textContent = score <= 99999
        ? score.toString().padStart(5, '0')
        : score.toString();
      cutinScoreValue.textContent = amount.toString();
    }
  };
  requestAnimationFrame(step);
}

function setRankStyle(style) {
  rankText.setAttribute("fill", `url(#${style})`);
  rankTextHighlight.setAttribute("fill", `url(#${style})`);
}

function showCutIn(isCorrect, text) {
  const cutin = document.querySelector('.cutin');
  const cutinImg = document.querySelector('.cutin-img');
  const countSvg = document.getElementById('countSvg');
  
  const cutinCountTxtBG = document.querySelector('#cutinCountTxtBG');
  const cutinCountTxt = document.querySelector('#cutinCountTxt');
  const cutinCountTxtHighlight = document.querySelector('#cutinCountTxtHighlight');
  
  const score = document.querySelector('.cutin-score');

  // 前回のアニメをリセット
  cutin.classList.remove('cutin', 'correct', 'wrong');
  void cutin.offsetWidth; // ★ 強制reflow：これで確実にリセット
  cutin.classList.add('cutin', isCorrect ? 'correct' : 'wrong');
  
  if(q.mode=='renda' || q.mode=='mikiri'){
    countSvg.style.display = '';
    cutinImg.style.display = 'none';
    
    if(q.mode=='renda'){
      cutinCountTxtBG.textContent = rendaCount + '回';
      cutinCountTxt.textContent = rendaCount + '回';
      cutinCountTxtHighlight.textContent = rendaCount + '回';
    }else if(q.mode=='mikiri'){
      let tapTimeSec = (Math.round((tapTime / 1000) * 100) / 100) + ' sec';
      if(!isCorrect){
        tapTimeSec = 'MISS'
      }
      cutinCountTxtBG.textContent = tapTimeSec;
      cutinCountTxt.textContent = tapTimeSec;
      cutinCountTxtHighlight.textContent = tapTimeSec;
    }
    
  }else{
    countSvg.style.display = 'none';
    cutinImg.style.display = '';
    
    if(q.answerPict && q.answerPict != '' && !isCorrect){
      cutinImg.src = q.answerPict;
    }else if(isCorrect){
      cutinImg.src = 'images/maru.png';
    } else {
      cutinImg.src = 'images/batsu.png';
    }
  }
  
  rankTextBG.textContent = text;
  rankText.textContent = text;
  rankHighlight.textContent = text;
  
  cutin.classList.remove('disappear');
  // アニメ発動
  cutin.classList.add('active');
  // 進捗バー更新
  const segments = document.querySelectorAll('.stage-progress-segment');
  if (segments[stageQuizIdx]) segments[stageQuizIdx].classList.add('filled');

  // 終了処理（帯拡大アニメーション終了後に非表示）
  var cutinShowTime = 1750;

  if(q.answerPict && q.answerPict != '' && !isCorrect){
    cutinShowTime = 3750; //長めに見せる
  }

  setTimeout(() => {
    cutin.classList.add('disappear');        
  }, cutinShowTime);
      
  setTimeout(() => {
    cutin.classList.remove('active');
    quizFinaly();
        
  }, cutinShowTime + 750);
}

function quizFinaly(){
  currentIndex++;
  stageQuizIdx++;
  
  if (currentIndex < quizData.length){
    if (stageQuizIdx >= nowStage.count){
      stageCount++;
      nowStage = stageData[stageCount];

      if(isHiroshi && nowStage.stage==4){
        //弘退場
        endQuiz();
        return;
      }

      showNextStage();
    }else{
      showQuestion();
    }
  }else{
    endQuiz();
  }
}

var stageCount = 0;
var stageQuizIdx = 0;
var nowStage = stageData[0];


function createProgressSegments(segmentCount) {
  const stageProgress = document.querySelector('.stage-progress');
  stageProgress.innerHTML = ''; // 既存をクリア
  
  for (let i = 0; i < segmentCount; i++) {
    const seg = document.createElement('div');
    seg.className = 'stage-progress-segment';
    stageProgress.appendChild(seg);
  }
}

const stageOverlay = document.getElementById('stage-overlay');
const stageOverlayTitle = document.getElementById('stage-overlay-title');
const stageOverlayLoading = document.getElementById('stage-overlay-loading');
const stageText = document.getElementById('stage-title');
const stageProgress = document.getElementById('stageProgress');
//最終ステージ演出
const lastLoadMsges = [
  "回答データ解析中…",
  "行動傾向の初期分析…",
  "特徴パターン抽出中…",
  "回答精度の分布を計測…",
  "類似回答との距離を測定…",
  "回答内容の偏差を計算…",
  "プロファイル候補を生成…",
  "属性推定モデルを更新中…",
  "回答速度の傾向を集計…",
  "推定年代を再計算…",
  "推定性別の精度検証…",
  "居住エリア候補を推定…",
  "回答履歴との相関を強化…",
  "行動プロファイルを統合中…",
  "特徴量の信頼度を評価…",
  "一致率の高い候補を抽出…",
  "残り情報を補完中…",
  "予測精度を最適化…",
  "識別モデルの再学習…",
  "プロファイルの整合性チェック…",
  "行動指標の重み付け調整…",
  "回答傾向の再スキャン…",
  "識別精度の閾値を修正…",
  "候補プロファイルを再ランキング…",
  "識別パラメータを展開中…",
  "候補データの重複排除…",
  "最終候補を絞り込み…",
  "個人識別スコアを算出…",
  "識別結果の整形処理…",
  "最終プロファイルを生成しています…"
];

function showNextStage(){

  document.getElementById('quiz-header').style.display = "none";
  document.getElementById('question').style.display = "none";
  document.getElementById('timer-container').style.display = "none";
  document.getElementById('buttons').style.display = "none";
  document.getElementById('banner').style.display = "";
  
  stageOverlayTitle.style.display = "none";
  stageOverlayLoading.style.display = "";
  
  stageOverlay.style.opacity='1';
  stageOverlay.style.display='';
  stageText.style.display='none';
  
  stageQuizIdx=0;
  
  if(nowStage.stage == 0){
    stageText.textContent = ``;
  }else if(nowStage.stage == FINAL_STAGE){
    stageText.textContent = `FINAL STAGE`;
    changeBanner('images/banner_mother2.gif');
  }else{
    stageText.textContent = `STAGE ` + nowStage.stage;
  }
  
  document.getElementById('loading-msg').style.display = "";
  document.getElementById('loading-msg').textContent = nowStage.loadMsg;
  document.getElementById('loadingBar').style.display = "";
  document.getElementById('loading-logo').style.display = '';
  document.getElementById('img-wrap').classList.remove('hide');

  stageProgress.style.width = "0%";
  stageOverlay.style.display = "flex";

  let progress = 0;
  stageProgress.style.transition = "none";
  stageProgress.style.width = "0%";

  let iconID = 0;

  const timer = setInterval(() => {
    // ランダムに進行量を変える（1/2は進行なし、1/2は0～9％）
    var upPt = Math.random() * 18 - 9;

    if(nowStage.stage == 0){
      //初回質問は加速
      upPt *= 3;
    }
    if(nowStage.stage == FINAL_STAGE){
      upPt = upPt / 3; //最終ステージは減速
      //中盤ははやめ
      if(progress > 35 && progress < 65){
        upPt = upPt + 3;
      }
    }

    if(kasoku){
      upPt *= 3;
    }

    if(upPt < 0) upPt = 0;
    progress += upPt;
    if (progress >= 100) progress = 100;

    if(nowStage.stage == FINAL_STAGE){
      //アイコンがみちよに……！！
      var nextIconID = Math.floor(progress / 3);

      if(progress==100){
        document.getElementById('loading-logo').src = 'images/michiyo.gif';
        setTimeout(() => {
          document.getElementById('loading-logo').src = 'images/logo_michi_99.png';
        }, 3000);
        document.getElementById('loading-msg').textContent = "あなたのことを完全に理解しました"
        changeBanner('images/banner_trans.png');
        playSound('understand');

      }else if(nextIconID > iconID){
        iconID = nextIconID;

        if(nextIconID > 30){
          document.getElementById('loading-logo').src = 'images/logo_michi_99.png';
        }else if(nextIconID >= 16){
          document.getElementById('img-wrap').classList.add('michi');
          document.getElementById('loading-logo').src = 'images/logo_michi_' + iconID + '.png';

          var michiTop = 25 + 2.5 / 15 * (30 - nextIconID);
          var michiHeight = 20 + 5 / 15 * (nextIconID -15);
          document.getElementById('img-wrap').style.top = '';
          document.getElementById('loading-logo').style.height = `${michiHeight}dvh`;
        }else{
          document.getElementById('loading-logo').src = 'images/logo_michi_' + iconID + '.png';
        }
        if(iconID < lastLoadMsges.length){
          document.getElementById('loading-msg').textContent = lastLoadMsges[iconID];
        }
      }
    }

    // 更新のたびに短いトランジションで滑らかに
    stageProgress.style.transition = "width 0.2s ease-out";
    stageProgress.style.width = progress + "%";

    // 100%に到達したら完了処理
    if (progress >= 100) {
      clearInterval(timer);

      if(nowStage.stage == FINAL_STAGE){

        nowBgm.pause();
        nowBgm.src = "";

        setTimeout(() => {
          //みちよスタート！！
          playSound('michiyo');
          //カラフルBG
          setTimeout(() => {
            changeBGColor(3);
            //ノリノリ
            document.getElementById('img-wrap').classList.add('float');
          }, 2000);
          setTimeout(() => {changeBGColor(2);}, 3000);
          setTimeout(() => {changeBGColor(1);}, 4000);
          setTimeout(() => {changeBGColor(2);}, 5000);
          setTimeout(() => {changeBGColor(3);}, 6000);
          setTimeout(() => {changeBGColor(4);}, 7000);
          setTimeout(() => {changeBGColor(3);}, 8000);
          setTimeout(() => {changeBGColor(2);}, 9000);
          setTimeout(() => {changeBGColor(1);}, 10000);
          setTimeout(() => {changeBGColor(2);}, 11000);
          setTimeout(() => {changeBGColor(3);}, 12000);
          setTimeout(() => {changeBGColor(4);}, 13000);

        }, 3000);


        //★出題再生位置調整
        setTimeout(() => {
          showNextStageFinaly();
        }, 16000);

      }else{
        showNextStageFinaly();
      }
    }
  }, 100); 
}

function changeBGColor(toNum){
  applyColor('--color-dark', '--color-dark-' + toNum);
  applyColor('--color-light', '--color-light-' + toNum);
  animateGradient(toNum);
}

function showNextStageFinaly(){

  setTimeout(() => {
    createProgressSegments(nowStage.count);
    if(nowStage.stage == FINAL_STAGE){
      document.getElementById('stage-info-title').textContent = `FINAL STAGE`;
    }else{
      document.getElementById('stage-info-title').textContent = `STAGE ` + nowStage.stage;
    }
    
    stageOverlayTitle.style.display = "";
    stageText.style.display = '';
    document.getElementById('stage-msg').textContent = nowStage.startMsg;
    stageProgress.style.width = "0%";

    document.getElementById('loading-logo').style.display = 'none';
    document.getElementById('loading-msg').style.display = "none";
    document.getElementById('loadingBar').style.display = "none";
    document.getElementById('img-wrap').classList.add('hide');

    if(nowStage.stage == 1){
      //背景の演出
      document.getElementById('stage-info').classList.add('appear');
    }else if(nowStage.stage > 1){
      //ステージ背景色の変更
      applyColor('--color-dark', '--color-dark-' + nowStage.stage);
      applyColor('--color-light', '--color-light-' + nowStage.stage);
      //accelerateBackground(); //背景モーションを加速
      animateGradient(nowStage.stage);
    }

    //bgm.volume = 0.5;
    playSound('lvup', 0.3);

    //バナー
    changeBanner(nowStage.banner);

    setTimeout(() => {
      if(kasoku){
        kasoku = false;
        count = 0;
      }else{
        count = 3;
      }
      showCountdown();
    }, 2000);

  }, 1000);
}


//背景グラデーションを変更
function animateGradient(stage) {
  const duration = 1000;
  const startTop = getComputedStyle(document.documentElement).getPropertyValue('--color-bg-top').trim();
  const startBottom = getComputedStyle(document.documentElement).getPropertyValue('--color-bg-bottom').trim();
  const endTop = getComputedStyle(document.documentElement).getPropertyValue(`--color-bg-top-${stage}`).trim();
  const endBottom = getComputedStyle(document.documentElement).getPropertyValue(`--color-bg-bottom-${stage}`).trim();

  const startTime = performance.now();

  function hexToRGB(hex){
    hex = hex.replace('#','');
    return [parseInt(hex.substr(0,2),16), parseInt(hex.substr(2,2),16), parseInt(hex.substr(4,2),16)];
  }

  function rgbToHex([r,g,b]){
    return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
  }

  function interpolateRGB(startHex, endHex, t){
    const start = hexToRGB(startHex);
    const end = hexToRGB(endHex);
    const interp = start.map((v,i) => Math.round(v + (end[i]-v)*t));
    return rgbToHex(interp);
  }

  function animate(time){
    const t = Math.min((time - startTime)/duration, 1); // 0→1
    const topColor = interpolateRGB(startTop, endTop, t);
    const bottomColor = interpolateRGB(startBottom, endBottom, t);

    document.documentElement.style.setProperty('--color-bg-top', topColor);
    document.documentElement.style.setProperty('--color-bg-bottom', bottomColor);

    if(t < 1) requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
}

//ステージ配色の変更
function applyColor(name, varName) {
  const value = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  document.documentElement.style.setProperty(name, value);
}

//背景を加速（現在不採用）
function accelerateBackground() {
  const body = document.body;
  const originalDuration = 50;  // 元のduration
  const fastDuration = 25;       // 加速時のduration
  const accelTime = 700;        // 加速にかける時間(ms)
  const decelTime = 700;       // 減速にかける時間(ms)

  function animateDuration(from, to, duration) {
    const start = performance.now();
    const diff = to - from;
    function step(now) {
      let t = (now - start) / duration;
      if (t > 1) t = 1;
      const eased = t<0.5 ? 2*t*t : -1 + (4-2*t)*t; // easeInOut
      body.style.animationDuration = (from + diff*eased) + 's';
      if (t < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  // 加速
  animateDuration(originalDuration, fastDuration, accelTime);
  // 減速
  setTimeout(() => animateDuration(fastDuration, originalDuration, decelTime), accelTime);
}

function init(){

  const hash = window.location.hash.substring(1); // #除去
  const params = new URLSearchParams(hash);

  if (params.has('infiniteMode')) {
    testMode = true;
  }

  document.getElementById('start').classList.add('pressed');

  //音声無効化を解除
  const a = new Audio();
  a.play().catch(()=>{});
  
  //タップ即再生じゃない音声は今生成し、事前に鳴らしておく
  bgm = prePlaySound('Specification');
  bgm_michiyo = prePlaySound('Michiyo');
  se_count = prePlaySound('count');
  se_lvup = prePlaySound('lvup');
  se_brazirian = prePlaySound('brazirian');
  se_re = prePlaySound('re');
  se_understand = prePlaySound('understand');
  se_picovoice = prePlaySound('picovoice');
  se_seven = prePlaySound('seven');
  bgm2 = prePlaySound('Specification');
  bgm3 = prePlaySound('Specification');
  bgm4 = prePlaySound('Specification');

  bgm_gainNode = connectAudio(bgm);
  michiyo_gainNode = connectAudio(bgm_michiyo);
  seven_gainNode = connectAudio(se_seven);

  /*
  bgm_michiyo.addEventListener("timeupdate", () => {
    //★アウトロループ　TODO
    if (bgm_michiyo.currentTime >= 119) {
      bgm_michiyo.currentTime = 103.2;
    }
  });
  */

  se_picovoice.addEventListener("timeupdate", () => {
    if (se_picovoice.currentTime >= 4.0) {
      se_picovoice.currentTime = 1.8;
    }
  });

  // stageData.count を quizData から自動生成
  const stageCounts = quizData.reduce((acc, q) => {
    acc[q.stage] = (acc[q.stage] || 0) + 1;
    return acc;
  }, {});

  stageData.forEach(s => {
    s.count = stageCounts[s.stage] || 0;
  });

  setTimeout(() => {
    document.getElementById('first-confirm').classList.remove('show');
    void document.getElementById('first-confirm').offsetWidth; // 再生リセット
    document.getElementById('first-confirm').classList.add('hide');
  }, 500);
  
  setTimeout(() => {
    document.getElementById('first-confirm').style.display = 'none';
    showNextStage();
  }, 1500);

}

// --- カウントダウン処理 ---
const overlay=document.getElementById('countdown-overlay');
const countNum=document.getElementById('countNum');
const container=document.querySelector('.container');
let count=3;

function showCountdown(){
  stageOverlayLoading.style.display = "none";

  countNum.textContent=count;
  countNum.style.opacity='1';
  
  //if(nowStage.stage == FINAL_STAGE){
  //  countNum.style.animation='moveUp 0.3s ease';
  //}

  countNum.style.animation='moveUp 0.7s ease';
  playSound('count');
  
  countNum.addEventListener('animationend',()=>{
    countNum.style.animation='none';
    countNum.style.opacity='0';
    count--;

    if(kasoku){
      count=0;
    }
  
    if(count>0){
      setTimeout(showCountdown,150);
    }else{
    
      stageOverlay.style.transition='opacity .5s';
      stageOverlay.style.opacity='0';
      countNum.style.opacity='0';
      
      var countdownInterval = 500;

      if(nowStage.stage == FINAL_STAGE){
        countdownInterval = 0;
      }

      setTimeout(()=>{
        stageOverlay.style.display='none';
      
        document.getElementById('quiz-header').style.display = "";
        document.getElementById('question').style.display = "";
        document.getElementById('timer-container').style.display = "";
        document.getElementById('buttons').style.display = "";
        
        if(nowStage.stage==FINAL_STAGE || nowStage.stage==1){

        }else{
          //BGMスピードを変更
          playBGM(nowStage.stage);
        }

        showQuestion();
      },countdownInterval);
    }
  },{once:true});
}


function endQuiz(){
  stopTimer();

  fadeOutAudio(bgm_michiyo, michiyo_gainNode, 3.5);
  
  // 白フェード用のdivを生成
  const fade = document.createElement('div');
  fade.style.position = 'fixed';
  fade.style.top = 0;
  fade.style.left = 0;
  fade.style.width = '100%';
  fade.style.height = '100%';
  fade.style.backgroundColor = '#fff';
  fade.style.opacity = '0';
  fade.style.transition = 'opacity 3s';
  fade.style.zIndex = 9999;
  document.body.appendChild(fade);
  
  // 100ms遅延してからフェード開始
  setTimeout(() => {
    fade.style.opacity = 1;
  }, 100);

  setTimeout(() => {
    if(isHiroshi){
      window.location.href = 'result-a.html#score=' + score; 
    }else{
      window.location.href = 'result.html#score=' + score; // 遷移先HTMLを指定
    }
  }, 3500);
}

// ==== 音声処理 ====
var bgm; 
var bgm2;
var bgm3;
var bgm4;
var nowBgm;
var bgm_michiyo; // = document.getElementById('bgm_michiyo');
var se_count; // = document.getElementById('se_count');
var se_lvup; // = document.getElementById('se_lvup');
var se_brazirian; // = document.getElementById('se_brazirian');
var se_re; // = document.getElementById('se_re');
var se_understand;
var se_picovoice; // = document.getElementById('se_picovoice');
var se_seven; // = document.getElementById('se_seven');
var bgm_gainNode;
var michiyo_gainNode;
var seven_gainNode;

const soundCache = {};

function preloadSounds(list){

  list.forEach(name=>{
    const a = new Audio('bgm/' + name + '.mp3');
    a.preload = 'auto';
    soundCache[name] = a;
  });
}

function prePlaySound(name){

  audio = new Audio('bgm/' + name + '.mp3');
  audio.preload = 'auto';

  switch (name) {
  case 'Specification':
  case 're':
  case 'picovoice':
    audio.loop = true;
  }

  switch (name) {
  case 'Specification':
    //ループが自然な位置に調整
    audio.addEventListener("timeupdate", () => {
      if (audio.currentTime >= 206) {
        audio.currentTime = 0;
      }
    });
  }

  audio.volume = 0.0;
  audio.play();
  audio.pause();
  return audio;
}

function playBGM(stage){

  var target;
  switch (stage) {
  case "0":
    target = bgm;
    stage++;
    break;
  case "1":
    target = bgm;
    break;
  case "2":
    target = bgm2;
    break;
  case "3":
    target = bgm3;
    break;
  case "4":
    target = bgm4;
    break;
  }
/*
  var nowCurrentTime = bgm.currentTime;
  bgm.src = "";
  a.playbackRate = rate
  a.currentTime = nowCurrentTime;
  */
  target.playbackRate = 0.9 + 0.1 * stage;
  target.volume = 1.0;

  if(stage > 1){
    nowBgm.pause();
    nowBgm.src = "";
    target.currentTime = nowBgm.currentTime;
  }
  target.play();

  nowBgm = target;
}

function playSound(name, vol = 1.0){

  if(name == 'michiyo'){
    bgm_michiyo.volume = 1.0;
    bgm_michiyo.play();

  }else if(name == 'understand'){
    se_understand.volume = 1.0;
    se_understand.play();

  }else if(name == 'count'){
    se_count.pause();
    se_count.volume = vol;
    se_count.currentTime = 0;
    se_count.play().then(()=>{
      // 再生が終わったら自動でリセットして pause
      se_count.addEventListener('ended', () => {
        se_count.currentTime = 0;
        se_count.pause();
      }, { once: true });
    }).catch(()=>{});

  }else if(name == 'lvup'){
    se_lvup.pause();
    se_lvup.volume = vol;
    se_lvup.currentTime = 0;
    se_lvup.play().then(()=>{
      // 再生が終わったら自動でリセットして pause
      se_lvup.addEventListener('ended', () => {
        se_lvup.currentTime = 0;
        se_lvup.pause();
      }, { once: true });
    }).catch(()=>{});

  }else if(name == 're'){
    se_re.volume = vol;
    se_re.play();
    
  }else if(name == 'bgm'){
    bgm.volume = vol;
    //bgm.currentTime = 0;
    bgm.play();
  }else if(name == 'brazirian'){
    se_brazirian.volume = vol;
    se_brazirian.currentTime = 0;
    se_brazirian.play();
  }else if(name == 'picovoice'){
    se_picovoice.volume = vol;
    se_picovoice.playbackRate = 1.2;
    se_picovoice.currentTime = 1.8;
    se_picovoice.play();
  }else if(name == 'seven'){
    nowBgm.volume = 0.5;
    fadeVolume(bgm_gainNode, 0.5, 0.5);
    se_seven.volume = vol;
    se_seven.play();
    //fadeVolume(seven_gainNode, 2.0, 0.5);
    var whileSeven = true;
    se_seven.addEventListener('ended', () => {
      fadeVolume(bgm_gainNode, 1.0, 0.5);
    }, { once: true });
  
  }else{
    const a = soundCache[name].cloneNode();
    a.volume = vol;   // 0.0〜1.0
    a.play();
  }
}

// 初期セットアップ（1回だけ）
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function connectAudio(audio){
  const source = audioCtx.createMediaElementSource(audio);
  const gain = audioCtx.createGain();
  source.connect(gain).connect(audioCtx.destination);
  return gain;
}

// フェードアウト（呼び出すだけ）
function fadeOutAudio(audio, gainNode, duration = 0.5){
  //const gainNode = connectAudio(audio);
  const now = audioCtx.currentTime;
  gainNode.gain.cancelScheduledValues(now);
  gainNode.gain.setValueAtTime(gainNode.gain.value, now);
  gainNode.gain.linearRampToValueAtTime(0, now + duration);

  setTimeout(() => {
    audio.pause();
    audio.currentTime = 0;
  }, duration * 1000);
}

function fadeVolume(gainNode, targetVolume = 0.3, duration = 0.5){
  const now = audioCtx.currentTime;
  gainNode.gain.cancelScheduledValues(now);
  gainNode.gain.setValueAtTime(gainNode.gain.value, now);
  gainNode.gain.linearRampToValueAtTime(targetVolume, now + duration);
}

function changeBanner(bannerSrc){
  const img = document.querySelector('.banner img');
  img.src = bannerSrc;
  if(bannerSrc=='images/banner_mother2.gif'){
    img.classList.add('trans');
  }else{
    img.classList.remove('trans');
  }

}


// ==== スマホ向けボタン押下制御 ====
function initButtonTouchEvents() {
  const buttons = document.querySelectorAll('button'); //.buttons button
  buttons.forEach(btn => {
    let isInside = false;

    btn.addEventListener('touchstart', () => {
      isInside = true;
      btn.classList.add('pressed');
    });

    btn.addEventListener('touchmove', e => {
      const touch = e.touches[0];
      const rect = btn.getBoundingClientRect();
      const inside =
        touch.clientX >= rect.left &&
        touch.clientX <= rect.right &&
        touch.clientY >= rect.top &&
        touch.clientY <= rect.bottom;
      if (inside && !isInside) {
        btn.classList.add('pressed');
        isInside = true;
      } else if (!inside && isInside) {
        btn.classList.remove('pressed');
        isInside = false;
      }
    });

    btn.addEventListener('touchend', e => {
      e.preventDefault(); // ←追加：ブラウザのclick発火を防ぐ    
      if (isInside) {
        //btn.classList.remove('pressed');
        btn.onclick();
        //handleAnswer(btn.innerHTML); // click()呼ばず、直接呼ぶ
      } else {
        btn.classList.remove('pressed');
      }
      isInside = false;
    });
  });
}

</script>
</body>
</html>